# Alpha-Z Triple Strategy Trading System Documentation

## 📊 시스템 개요

Alpha-Z Triple Strategy는 A전략(15분봉 바닥타점), B전략(15분봉 급등초입), C전략(3분봉 바닥급등타점)을 통합한 고도화된 암호화폐 선물 거래 시스템입니다.

### 🎯 핵심 특징
- **다중 전략**: 3개 전략의 시너지 효과로 다양한 시장 상황 대응
- **고레버리지**: 20배 레버리지를 활용한 효율적 자본 활용
- **DCA 시스템**: 3단계 분할매수로 리스크 관리
- **실시간 모니터링**: WebSocket + REST API 하이브리드 데이터 수집
- **자동 청산**: 8가지 청산 조건으로 수익 극대화 및 손실 최소화

## ⚙️ 시스템 설정

### 기본 거래 설정
```yaml
레버리지: 20배
포지션 크기: 원금 1.0% × 20배 레버리지 = 20% 노출
최대 진입 종목: 20종목
재진입: 순환매 활성화 (최초진입가 기준 청산모드 전환)
단계별 손절: 초기 -10% (시드 대비 6% 손실)
종목당 최대 비중: 3.0% (초기 1.0% + DCA 1.0% + 1.0%)
최대 원금 사용: 60% (20종목 × 3.0%)
손실 계산: 총 3% × 20배 × -10% = 시드의 6% 손실
```

### DCA (Dollar Cost Averaging) 시스템
```yaml
최초 진입: 1.0% × 20배 = 20% 노출 시장가 매수
1차 DCA: -3% 하락가에 1.0% × 20배 지정가 주문 (즉시 등록)
2차 DCA: -6% 하락가에 1.0% × 20배 지정가 주문 (즉시 등록)
전량 손절: -10% (시드 대비 6% 손실)
```

## 📈 전략별 상세 조건

### A전략: 15분봉 바닥타점 (임시 비활성화)
**목적**: MA80 < MA480 조건에서 볼린저밴드와 골든크로스 조건으로 바닥 타점 포착

**조건 구성**:
- MA80 < MA480 and BB복합조건 및 골든크로스 and 시가대비고가조건
- 현재 임시 비활성화 상태

### B전략: 15분봉 급등초입 (6개 조건)
**목적**: 급등 초기 진입을 목표로 하는 안정적인 전략

#### 📈 조건 1: MA80-MA480 골든크로스 (200봉이내)
- 200봉 이내에 MA80이 MA480을 상향 돌파한 골든크로스 발생
- 이전봉: `MA80 < MA480`, 현재봉: `MA80 >= MA480`

#### 🎈 조건 2: BB 골든크로스 (200봉이내)
- **BB200상단선(표준편차2) - BB480상단선(표준편차1.5)** 골든크로스 또는 이격도 1%이내
- **BB80상단선(표준편차2) - BB480상단선(표준편차1.5)** 골든크로스 또는 이격도 1%이내
- 둘 중 하나라도 만족하면 조건 충족

#### ⚡ 조건 3: MA5-MA20 골든크로스 + 현재가 조건
- **10봉이내 1봉전 MA5-MA20 골든크로스** AND **현재가 조건**
- 현재가 조건: `현재가 < MA5` 또는 `현재가-MA5 이격도 0.5%이내`

#### 🚀 조건 4: BB200상단-MA480 상향돌파 (250봉이내)
- 250봉 이내에 BB200상단선이 MA480을 상향 돌파
- 이전봉: `BB200상단 <= MA480`, 현재봉: `BB200상단 > MA480`

#### 🔄 조건 5: 데드크로스/이격도/시가대비고가+BB480 조건
다음 3가지 중 **하나라도 만족**하면 조건 충족:
1. **40봉이내 MA20-MA80 데드크로스**
2. **이격도 조건**: `MA5-MA80 이격도 1%이내` 또는 `MA20-MA80 이격도 2%이내`
3. **시가대비고가15%+BB480조건**: `100봉이내 시가대비고가 15%이상` AND (`MA5 < BB480상단` 또는 `MA5-BB480상단 이격도 2%이내`)

#### 📊 조건 6: 시가대비고가 3%이상 (200봉이내)
- 200봉 이내에 시가대비고가 상승률이 3%이상인 봉이 **1회이상** 존재
- 계산식: `((고가 - 시가) / 시가) × 100 >= 3.0`

**B전략 최종 신호**: 모든 6개 조건이 True여야 매수 신호 발생

### C전략: 3분봉 바닥급등타점 (4개 조건)
**목적**: 3분봉과 1분봉을 활용한 빠르고 민감한 바닥 급등 타점 전략

#### 📈 조건 1: MA80-MA480 조건 (300봉이내)
- **현재봉 MA80 < MA480** OR **300봉이내 MA80-MA480 골든크로스**
- B전략보다 유연: 현재 상황 또는 골든크로스 둘 다 허용

#### 🎈 조건 2: BB80-BB480 골든크로스 (300봉이내)
- 3분봉 300봉이내 BB80상단선(표준편차2)-BB480상단선(표준편차1.5) 골든크로스
- B전략보다 긴 기간으로 더 안정적인 신호 확보

#### ⚡ 조건 3: MA5-MA20 골든크로스 OR 복합조건 (10봉이내)
**방법1**: 10봉이내 MA5-MA20 골든크로스
**방법2**: 복합조건
- 현재 MA5-MA20 이격도 1%이내
- 10봉이내 MA5-MA20 데드크로스 없음
- MA20위에서 MA5가 2회이상 상승

#### 🔥 조건 4: 1분봉 MA5-MA20 골든크로스 (10봉이내)
- **1분봉** 10봉이내 MA5-MA20 골든크로스
- B전략에는 없는 초단기 확인 조건

**C전략 최종 신호**: 모든 4개 조건이 True여야 매수 신호 발생

## 🔍 전략 비교 분석

| **구분** | **B전략 (15분봉)** | **C전략 (3분봉)** |
|---------|------------------|------------------|
| **타임프레임** | 15분봉 기준 | 3분봉 + 1분봉 기준 |
| **조건 개수** | 6개 조건 | 4개 조건 |
| **복잡도** | 복잡 (다양한 조건) | 단순 (핵심만 집중) |
| **MA조건** | 골든크로스만 | 골든크로스 OR 현재상황 |
| **BB조건** | BB200+BB80 (200봉) | BB80만 (300봉) |
| **특별조건** | 시가대비고가 3% | 1분봉 골든크로스 |
| **진입타이밍** | 급등 초입 | 바닥 급등 타점 |
| **신호빈도** | 낮음 (엄격) | 높음 (유연) |

### 전략별 특징
**B전략**:
- ✅ 안정성: 6개 조건으로 강력한 필터링
- ✅ 급등초입: 상승 모멘텀 초기 포착
- ❌ 기회손실: 엄격한 조건으로 진입 기회 제한

**C전략**:
- ✅ 빠른진입: 3분봉+1분봉으로 조기 진입
- ✅ 유연성: OR 조건으로 다양한 상황 대응
- ✅ 바닥타점: 하락 후 반등 시점 포착

## 💎 포트폴리오 관리 시스템

### 포지션 모니터링
```
순번  심볼      레버리지수익률  원금수익률   수익금액    진입가      진입금액
1     HANA      -108.1%       -5.41%      $-0.49     $0.0220     $0.48
2     ONT       -85.5%        -4.28%      $-0.39     $0.0850     $0.47
```

### DCA 주문 관리 시스템
**자동 DCA 주문 관리**:
- 포지션 마진 분석으로 진입 단계 자동 판별
- 누락된 DCA 주문 자동 복구
- 중복 주문 방지 및 정리
- 실시간 DCA 상태 모니터링

**마진 기반 단계 판별**:
- `margin_ratio < 1.5`: 최초 진입 단계
- `1.5 <= margin_ratio < 2.5`: 1차 DCA 완료
- `margin_ratio >= 2.5`: 2차 DCA 완료

## 🚀 기술적 구현

### 데이터 수집 시스템
- **WebSocket Provider**: 실시간 캐시된 OHLCV 데이터
- **REST API Backup**: WebSocket 실패시 백업
- **하이브리드 접근**: 성능과 안정성 양립
- **API 제한 최적화**: 불필요한 호출 최소화

### 기술적 지표
```python
MA5, MA20, MA80, MA480: 이동평균선
BB80, BB200, BB480: 볼린저 밴드 (다양한 주기와 표준편차)
Volume: 거래량 분석
Price Action: 시가대비고가 상승률 계산
```

### 청산 시스템 (8가지)
1. **SuperTrend 전량청산**
2. **10% 수익 달성시 50% 익절청산**
3. **BB600 50% 익절청산**
4. **절반 하락 청산**
5. **약상승후 급락 리스크 회피**
6. **BB80-BB600 역전 기반 전량청산**
7. **DCA 순환매 일부청산**
8. **시간 기반 자동 청산** - 2시간 이상 보유하고 원금 수익률이 0~5% 이하인 경우 전량 청산

## ⚠️ 리스크 관리

### 손실 제한
- **종목당 최대 손실**: 3.0% × 20배 × -10% = 6% 손실
- **전체 포트폴리오**: 최대 60% 원금 사용으로 리스크 분산
- **자동 손절**: -10% 도달시 전량 자동 청산

### 포지션 제한
- **최대 동시 포지션**: 20종목
- **중복 포지션 방지**: 이미 보유 중인 종목 진입 차단
- **잔고 검증**: 충분한 잔고 확인 후 진입

### DCA 안전장치
- **단계별 분할**: 리스크를 3단계로 분산
- **자동 복구**: 누락된 주문 자동 감지 및 복구
- **마진 모니터링**: 실시간 포지션 상태 추적

## 📊 성능 최적화

### 스캔 최적화
- **필터링 단계**: 24시간 상승률 → 4시간봉 → 전략 조건
- **병렬 처리**: 다중 심볼 동시 분석
- **캐시 활용**: WebSocket 데이터 캐싱으로 API 호출 최소화

### 메모리 관리
- **데이터 정리**: 불필요한 히스토리 데이터 주기적 정리
- **효율적 저장**: 필수 데이터만 메모리 유지
- **가비지 컬렉션**: 자동 메모리 정리

## 🔧 최근 업데이트 히스토리

### 2024-11-11: 시간 기반 자동 청산 기능 추가
1. **새로운 청산 조건 추가**: 8번째 청산 방식으로 시간 기반 자동 청산 구현
2. **청산 조건**: 2시간 이상 보유 + 원금 수익률이 0~5% 이하인 경우 전량 자동 청산
3. **우선순위**: 손절 다음으로 높은 우선순위 (2순위) 적용
4. **텔레그램 알림**: ⏰ 시간 기반 청산 완료 메시지 추가

### 2024-11-11: 시스템 안정화 및 기능 개선
1. **투입금액 표시 오류 수정**: "$0 USDT" 표시 문제 해결
2. **DCA 매니저 오류 처리**: 'str' object has no attribute 'get' 오류 수정
3. **최대 포지션 확장**: 15개 → 20개로 확장
4. **전략 조건 최적화**: C전략 조건1, 조건2를 100봉 → 300봉으로 확장

### 주요 수정 사항

#### 투입금액 계산 수정
- **문제**: 예외 발생시 `position_value`가 0으로 표시
- **해결**: 변수 스코프 개선 및 예외 처리에서 잔고 재조회

#### DCA 매니저 안정화
- **문제**: 포지션 데이터 타입 불일치로 인한 오류
- **해결**: 데이터 타입 검증 및 안전한 접근 방식 구현

#### 포지션 한도 확장
- **변경**: 최대 15종목 → 20종목
- **영향**: 최대 원금 사용 45% → 60%로 증가

#### C전략 조건 강화
- **조건1**: MA80-MA480 조건을 300봉으로 확장
- **조건2**: BB80-BB480 골든크로스를 300봉으로 확장
- **데이터**: 요청량을 600봉 → 850봉으로 증가

## 🎯 운영 가이드

### 시작 전 체크리스트
1. **API 키 설정**: binance_config.py에 올바른 API 키 설정
2. **텔레그램 봇**: telegram_bot.py 설정 (선택사항)
3. **잔고 확인**: 충분한 USDT 잔고 보유
4. **네트워크 상태**: 안정적인 인터넷 연결

### 모니터링 포인트
- **포지션 수**: 20개 한도 내 유지
- **총 PnL**: 전체 손익 추적
- **DCA 주문**: 누락된 주문 자동 복구 확인
- **API 제한**: 호출 한도 초과 방지

### 비상 상황 대응
- **강제 청산**: 모든 포지션 수동 청산
- **DCA 주문 취소**: 미체결 주문 일괄 취소
- **시스템 재시작**: 오류 발생시 안전한 재시작

## 📚 기술 문서

### 코드 구조
```
alpha_z_triple_strategy.py          # 메인 전략 파일
├── AlphaZTripleStrategy            # 메인 클래스
├── _check_strategy_a_bottom_entry  # A전략 체크
├── _check_strategy_b_uptrend_entry # B전략 체크
├── _check_strategy_c_3min_precision # C전략 체크
├── execute_trade                   # 실제 거래 실행
├── _manage_dca_orders_by_margin    # DCA 주문 관리
├── check_real_position_status      # 포지션 상태 체크
├── get_portfolio_summary           # 포트폴리오 요약
└── _print_portfolio_table          # 포지션 테이블 출력

improved_dca_position_manager.py    # DCA 관리 시스템
websocket_ohlcv_provider.py        # WebSocket 데이터 제공
telegram_bot.py                    # 텔레그램 알림 (선택)
binance_config.py                  # API 설정
```

### 로깅 시스템
- **ERROR**: 심각한 오류 (거래 실패, 시스템 오류)
- **WARNING**: 경고 (잔고 부족, API 제한)
- **INFO**: 정보 (거래 완료, 상태 변경)
- **DEBUG**: 디버그 (상세 분석 정보)

## 🚨 주의사항

### 투자 리스크
- **고위험 투자**: 20배 레버리지는 높은 수익과 높은 리스크 수반
- **시장 변동성**: 암호화폐 시장의 높은 변동성 주의
- **자동 거래**: 시스템 의존도가 높으므로 지속적인 모니터링 필요

### 시스템 리스크
- **네트워크 장애**: 인터넷 연결 불안정시 거래 실행 불가
- **API 제한**: 바이낸스 API 호출 한도 초과시 거래 중단
- **시스템 오류**: 예상치 못한 버그로 인한 거래 오류 가능

### 권장사항
- **소액 테스트**: 처음에는 소액으로 시스템 테스트
- **지속 모니터링**: 포지션과 PnL 정기적 확인
- **백업 계획**: 수동 거래 준비 및 비상 계획 수립
- **위험 관리**: 투자 금액은 손실 감당 가능한 수준으로 제한

---

*본 문서는 Alpha-Z Triple Strategy Trading System의 공식 기술 문서입니다. 지속적으로 업데이트되며, 최신 버전은 프로젝트 레포지토리에서 확인할 수 있습니다.*

**마지막 업데이트**: 2024-11-11  
**버전**: v2.1.0  
**작성자**: Claude AI Assistant